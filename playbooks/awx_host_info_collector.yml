- name: 🔄 Sincronizar VM do AWX para NetBox
  hosts: localhost
  gather_facts: false
  vars:
    awx_url: "http://10.0.100.159:8013"
    awx_username: "junior"
    awx_password: "JR83silV@83"
    inventory_id: 3
    target_vm: "ADAASD-SIDAPI01"
  tasks:
    - name: 📡 Buscar VM no inventário AWX
      uri:
        url: "{{ awx_url }}/api/v2/inventories/{{ inventory_id }}/hosts/?name={{ target_vm }}"
        method: GET
        user: "{{ awx_username }}"
        password: "{{ awx_password }}"
        force_basic_auth: true
        return_content: true
        status_code: 200
        validate_certs: false
      register: vm_lookup

    - name: ❌ Falhar se VM não encontrada
      fail:
        msg: "VM '{{ target_vm }}' não encontrada no inventário {{ inventory_id }}."
      when: (vm_lookup.json.count | int) == 0

    - name: 📋 Definir ID da VM encontrada
      set_fact:
        vm_id: "{{ vm_lookup.json.results[0].id }}"

    - name: 🔍 Obter detalhes da VM
      uri:
        url: "{{ awx_url }}/api/v2/hosts/{{ vm_id }}/"
        method: GET
        user: "{{ awx_username }}"
        password: "{{ awx_password }}"
        force_basic_auth: true
        return_content: true
        status_code: 200
        validate_certs: false
      register: vm_details

    - name: 🧾 Extrair variáveis da VM
      set_fact:
        vm_variables: "{{ vm_details.json.variables | from_yaml }}"

    - name: 🖥️ Mostrar variáveis da VM
      debug:
        var: vm_variables
