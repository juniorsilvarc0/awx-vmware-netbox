- name: ðŸ“Š AWX Host Information Collector
  hosts: localhost
  gather_facts: false
  vars:
    ansible_connection: local
    # ConfiguraÃ§Ãµes do AWX (credenciais injetadas via environment)
    awx_url: "{{ awx_api_url | default('http://10.0.100.159:8013') }}"
    inventory_id: "{{ awx_inventory_id | default(3) }}"
    target_host: "{{ host_name | default('ADAASD-SIDAPI01') }}"
    # Credenciais obtidas via environment variables injetadas pelo AWX
    awx_username: "{{ ansible_env.AWX_USERNAME }}"
    awx_password: "{{ ansible_env.AWX_PASSWORD }}"
  
  tasks:
    - name: ðŸ” Buscar informaÃ§Ãµes do host via API do AWX
      uri:
        url: "{{ awx_url }}/api/v2/inventories/{{ inventory_id }}/hosts/?name={{ target_host }}"
        method: GET
        user: "{{ ansible_env.AWX_USERNAME }}"
        password: "{{ ansible_env.AWX_PASSWORD }}"
        force_basic_auth: yes
        return_content: yes
      register: host_search_result
      no_log: true

    - name: âŒ Falha - Host nÃ£o encontrado
      debug:
        msg: |
          âŒ Host '{{ target_host }}' nÃ£o encontrado no inventÃ¡rio ID {{ inventory_id }}
          
          Verifique se:
          - O nome do host estÃ¡ correto
          - O inventÃ¡rio estÃ¡ sincronizado
          - As credenciais estÃ£o corretas
      when: host_search_result.json.count == 0

    - name: ðŸ“‹ Listar hosts disponÃ­veis quando nÃ£o encontrado
      uri:
        url: "{{ awx_url }}/api/v2/inventories/{{ inventory_id }}/hosts/"
        method: GET
        user: "{{ ansible_env.AWX_USERNAME }}"
        password: "{{ ansible_env.AWX_PASSWORD }}"
        force_basic_auth: yes
        return_content: yes
      register: available_hosts
      when: host_search_result.json.count == 0
      no_log: true

    - name: ðŸ–¥ï¸ Mostrar hosts disponÃ­veis
      debug:
        msg: |
          ðŸ–¥ï¸ Hosts disponÃ­veis no inventÃ¡rio VMware Inventory:
          {% for host in available_hosts.json.results %}
          â€¢ {{ host.name }} (ID: {{ host.id }})
          {% endfor %}
      when: host_search_result.json.count == 0 and available_hosts.json.results | length > 0

    - name: âœ… Definir informaÃ§Ãµes do host encontrado
      set_fact:
        found_host: "{{ host_search_result.json.results[0] }}"
      when: host_search_result.json.count > 0

    - name: ðŸ“Š Exibir informaÃ§Ãµes bÃ¡sicas do host
      debug:
        msg: |
          âœ… Host encontrado:
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ðŸ” Nome: {{ found_host.name }}
          ðŸ†” ID: {{ found_host.id }}
          ðŸ“ DescriÃ§Ã£o: {{ found_host.description | default('Sem descriÃ§Ã£o') }}
          ðŸŸ¢ Ativo: {{ found_host.enabled }}
          ðŸ“… Criado em: {{ found_host.created }}
          ðŸ”„ Modificado em: {{ found_host.modified }}
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      when: host_search_result.json.count > 0

    - name: ðŸ”§ Obter detalhes completos do host
      uri:
        url: "{{ awx_url }}/api/v2/hosts/{{ found_host.id }}/"
        method: GET
        user: "{{ ansible_env.AWX_USERNAME }}"
        password: "{{ ansible_env.AWX_PASSWORD }}"
        force_basic_auth: yes
        return_content: yes
      register: host_details
      when: host_search_result.json.count > 0
      no_log: true

    - name: ðŸ“‹ Exibir variÃ¡veis do host
      debug:
        msg: |
          ðŸ”§ VariÃ¡veis do host:
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          {% if host_details.json.variables %}
          {{ host_details.json.variables | to_nice_json }}
          {% else %}
          â„¹ï¸ Nenhuma variÃ¡vel definida no host
          {% endif %}
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      when: host_search_result.json.count > 0

    - name: ðŸ“Š Obter Ansible Facts do host
      uri:
        url: "{{ awx_url }}/api/v2/hosts/{{ found_host.id }}/ansible_facts/"
        method: GET
        user: "{{ ansible_env.AWX_USERNAME }}"
        password: "{{ ansible_env.AWX_PASSWORD }}"
        force_basic_auth: yes
        return_content: yes
      register: host_facts
      when: host_search_result.json.count > 0
      no_log: true

    - name: ðŸ–¥ï¸ Exibir informaÃ§Ãµes do sistema
      debug:
        msg: |
          ðŸ–¥ï¸ InformaÃ§Ãµes do sistema:
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ðŸ“ Hostname: {{ host_facts.json.ansible_hostname | default('N/A') }}
          ðŸŒ FQDN: {{ host_facts.json.ansible_fqdn | default('N/A') }}
          ðŸ–¥ï¸ OS Family: {{ host_facts.json.ansible_os_family | default('N/A') }}
          ðŸ“€ DistribuiÃ§Ã£o: {{ host_facts.json.ansible_distribution | default('N/A') }}
          ðŸ”¢ VersÃ£o: {{ host_facts.json.ansible_distribution_version | default('N/A') }}
          ðŸ—ï¸ Arquitetura: {{ host_facts.json.ansible_architecture | default('N/A') }}
          ðŸ§  CPU Cores: {{ host_facts.json.ansible_processor_cores | default('N/A') }}
          ðŸ’¾ MemÃ³ria (MB): {{ host_facts.json.ansible_memtotal_mb | default('N/A') }}
          ðŸ“¡ IP Principal: {{ host_facts.json.ansible_default_ipv4.address | default('N/A') }}
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      when: host_search_result.json.count > 0 and host_facts.json

    - name: ðŸŒ Exibir interfaces de rede
      debug:
        msg: |
          ðŸŒ Interfaces de rede:
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          {% for interface in host_facts.json.ansible_interfaces | default([]) %}
          {% set interface_data = host_facts.json['ansible_' + interface] | default({}) %}
          {% if interface_data.ipv4 is defined %}
          ðŸ”Œ {{ interface }}: {{ interface_data.ipv4.address | default('sem IP') }}
          {% endif %}
          {% endfor %}
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      when: host_search_result.json.count > 0 and host_facts.json and host_facts.json.ansible_interfaces is defined

    - name: ðŸ‘¥ Obter grupos do host
      uri:
        url: "{{ awx_url }}/api/v2/hosts/{{ found_host.id }}/groups/"
        method: GET
        user: "{{ ansible_env.AWX_USERNAME }}"
        password: "{{ ansible_env.AWX_PASSWORD }}"
        force_basic_auth: yes
        return_content: yes
      register: host_groups
      when: host_search_result.json.count > 0
      no_log: true

    - name: ðŸ·ï¸ Exibir grupos do host
      debug:
        msg: |
          ðŸ‘¥ Grupos do host:
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          {% if host_groups.json.count > 0 %}
          âœ… Host pertence a {{ host_groups.json.count }} grupo(s):
          {% for group in host_groups.json.results %}
          ðŸ‘¥ {{ group.name }} (ID: {{ group.id }})
          {% endfor %}
          {% else %}
          â„¹ï¸ Host nÃ£o pertence a nenhum grupo
          {% endif %}
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      when: host_search_result.json.count > 0

    - name: ðŸŽ¯ Comandos Ãºteis para consulta
      debug:
        msg: |
          ðŸŽ¯ Comandos Ãºteis:
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          # VariÃ¡veis do host
          curl -u '{{ awx_username }}:{{ awx_password }}' '{{ awx_url }}/api/v2/hosts/{{ found_host.id }}/' | jq '.variables'
          
          # Facts do host
          curl -u '{{ awx_username }}:{{ awx_password }}' '{{ awx_url }}/api/v2/hosts/{{ found_host.id }}/ansible_facts/'
          
          # Grupos do host
          curl -u '{{ awx_username }}:{{ awx_password }}' '{{ awx_url }}/api/v2/hosts/{{ found_host.id }}/groups/'
          
          # Executar script Python
          python3 scripts/awx_host_info.py {{ found_host.name }}
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      when: host_search_result.json.count > 0

    - name: ðŸ“„ Exportar dados do host em JSON
      copy:
        content: |
          {
            "host_info": {{ found_host | to_nice_json }},
            "host_details": {{ host_details.json | to_nice_json }},
            "ansible_facts": {{ host_facts.json | to_nice_json }},
            "host_groups": {{ host_groups.json | to_nice_json }},
            "collection_time": "{{ ansible_date_time.iso8601 }}",
            "collected_by": "AWX Host Info Collector Playbook"
          }
        dest: "/tmp/host_info_{{ found_host.name }}_{{ ansible_date_time.epoch }}.json"
      when: host_search_result.json.count > 0

    - name: ðŸ’¾ Informar localizaÃ§Ã£o do arquivo exportado
      debug:
        msg: |
          ðŸ’¾ Dados exportados para:
          ðŸ“ /tmp/host_info_{{ found_host.name }}_{{ ansible_date_time.epoch }}.json
          
          ðŸ“Š Dados incluÃ­dos:
          â€¢ InformaÃ§Ãµes bÃ¡sicas do host
          â€¢ VariÃ¡veis do host
          â€¢ Ansible Facts completos
          â€¢ Grupos do host
          â€¢ Timestamp da coleta
      when: host_search_result.json.count > 0
