---
- name: ğŸ“Š Coletar InformaÃ§Ãµes do Host via API AWX
  hosts: localhost
  gather_facts: false
  vars:
    ansible_connection: local
    awx_url: "http://localhost:8013"
    awx_username: "{{ lookup('env', 'AWX_USERNAME') | default('junior') }}"
    awx_password: "{{ lookup('env', 'AWX_PASSWORD') | default('') }}"
    awx_inventory_id: "{{ lookup('env', 'AWX_INVENTORY_ID') | default('3') }}"
    target_host: "{{ lookup('env', 'TARGET_HOST') | default('ADAASD-SIDAPI01') }}"

  tasks:
    - name: ğŸ” Validar credenciais AWX
      fail:
        msg: |
          âŒ Credenciais AWX nÃ£o configuradas!
          Configure a variÃ¡vel AWX_PASSWORD ou defina awx_password
      when: awx_password == '' or awx_password is not defined

    - name: ğŸ” Buscar host {{ target_host }} no inventÃ¡rio AWX
      uri:
        url: "{{ awx_url }}/api/v2/inventories/{{ awx_inventory_id }}/hosts/"
        method: GET
        user: "{{ awx_username }}"
        password: "{{ awx_password }}"
        force_basic_auth: true
        return_content: true
        status_code: [200]
        validate_certs: false
      register: awx_hosts_response

    - name: ğŸ“‹ Filtrar host especÃ­fico
      set_fact:
        target_host_data: "{{ awx_hosts_response.json.results | selectattr('name', 'equalto', target_host) | list | first | default({}) }}"

    - name: âŒ Falhar se host nÃ£o encontrado
      fail:
        msg: |
          Host '{{ target_host }}' nÃ£o encontrado no inventÃ¡rio {{ awx_inventory_id }}.
          Hosts disponÃ­veis: {{ awx_hosts_response.json.results | map(attribute='name') | list | join(', ') }}
      when: target_host_data == {}

    - name: âœ… Host encontrado - InformaÃ§Ãµes bÃ¡sicas
      debug:
        msg:
          - "ğŸ¯ Host: {{ target_host_data.name }}"
          - "ğŸ†” ID: {{ target_host_data.id }}"
          - "ğŸ“ DescriÃ§Ã£o: {{ target_host_data.description | default('N/A') }}"
          - "ğŸ”„ Habilitado: {{ target_host_data.enabled }}"

    - name: ğŸ”§ Obter detalhes completos do host
      uri:
        url: "{{ awx_url }}/api/v2/hosts/{{ target_host_data.id }}/"
        method: GET
        user: "{{ awx_username }}"
        password: "{{ awx_password }}"
        force_basic_auth: true
        return_content: true
        status_code: [200]
        validate_certs: false
      register: awx_host_details

    - name: ğŸ“Š Extrair variÃ¡veis do host
      set_fact:
        host_variables: "{{ awx_host_details.json.variables | from_yaml if awx_host_details.json.variables else {} }}"

    - name: ğŸ”§ Mostrar variÃ¡veis do host
      debug:
        msg:
          - "ğŸ“¦ VariÃ¡veis do host {{ target_host }}:"
          - "{{ host_variables | to_nice_yaml if host_variables else 'â„¹ï¸ Nenhuma variÃ¡vel definida' }}"

    - name: ğŸ–¥ï¸ Obter Ansible Facts do host
      uri:
        url: "{{ awx_url }}/api/v2/hosts/{{ target_host_data.id }}/ansible_facts/"
        method: GET
        user: "{{ awx_username }}"
        password: "{{ awx_password }}"
        force_basic_auth: true
        return_content: true
        status_code: [200, 404]
        validate_certs: false
      register: awx_ansible_facts
      failed_when: false

    - name: ğŸ“Š Processar Ansible Facts
      set_fact:
        system_facts: "{{ awx_ansible_facts.json if awx_ansible_facts.status == 200 else {} }}"

    - name: ğŸ–¥ï¸ Mostrar informaÃ§Ãµes do sistema
      debug:
        msg:
          - "ğŸ” InformaÃ§Ãµes do Sistema:"
          - "  ğŸ·ï¸ Hostname: {{ system_facts.ansible_hostname | default('N/A') }}"
          - "  ğŸŒ FQDN: {{ system_facts.ansible_fqdn | default('N/A') }}"
          - "  ğŸ¢ OS Family: {{ system_facts.ansible_os_family | default('N/A') }}"
          - "  ğŸ’¿ DistribuiÃ§Ã£o: {{ system_facts.ansible_distribution | default('N/A') }} {{ system_facts.ansible_distribution_version | default('') }}"
          - "  ğŸ—ï¸ Arquitetura: {{ system_facts.ansible_architecture | default('N/A') }}"
          - "  ğŸ’¾ CPU Cores: {{ system_facts.ansible_processor_cores | default('N/A') }}"
          - "  ğŸ§  MemÃ³ria (MB): {{ system_facts.ansible_memtotal_mb | default('N/A') }}"
          - "  ğŸŒ IP Principal: {{ system_facts.ansible_default_ipv4.address | default('N/A') }}"
      when: system_facts != {}

    - name: ğŸŒ Processar interfaces de rede
      set_fact:
        network_interfaces: >-
          {{
            system_facts.ansible_interfaces | default([]) |
            map('regex_replace', '^(.*)$', 'ansible_\1') |
            map('extract', system_facts, 'ipv4') |
            select('defined') |
            list
          }}
      when: system_facts != {}

    - name: ğŸŒ Mostrar interfaces de rede
      debug:
        msg:
          - "ğŸŒ Interfaces de Rede:"
          - "{{ network_interfaces | map('default', {'address': 'sem IP'}) | map(attribute='address') | list }}"
      when: 
        - system_facts != {}
        - network_interfaces is defined

    - name: ğŸ‘¥ Obter grupos do host
      uri:
        url: "{{ awx_url }}/api/v2/hosts/{{ target_host_data.id }}/groups/"
        method: GET
        user: "{{ awx_username }}"
        password: "{{ awx_password }}"
        force_basic_auth: true
        return_content: true
        status_code: [200]
        validate_certs: false
      register: awx_host_groups

    - name: ğŸ‘¥ Mostrar grupos do host
      debug:
        msg:
          - "ğŸ‘¥ Grupos do host:"
          - "{{ awx_host_groups.json.results | map(attribute='name') | list | join(', ') if awx_host_groups.json.results else 'â„¹ï¸ Host nÃ£o pertence a nenhum grupo' }}"

    - name: ğŸ“„ Gerar relatÃ³rio consolidado
      debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘        ğŸ“Š RELATÃ“RIO DO HOST            â•‘"
          - "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          - "â•‘ ğŸ¯ Host: {{ target_host_data.name.ljust(27) }} â•‘"
          - "â•‘ ğŸ†” AWX ID: {{ target_host_data.id | string | ljust(24) }} â•‘"
          - "â•‘ ğŸ“¦ InventÃ¡rio: {{ awx_inventory_id.ljust(20) }} â•‘"
          - "â•‘ ğŸ”„ Status: {{ ('Ativo' if target_host_data.enabled else 'Inativo').ljust(24) }} â•‘"
          - "â•‘ ğŸ‘¥ Grupos: {{ (awx_host_groups.json.results | length | string).ljust(24) }} â•‘"
          - "â•‘ ğŸ”§ VariÃ¡veis: {{ (host_variables | length | string).ljust(19) }} â•‘"
          - "â•‘ ğŸ–¥ï¸ Facts: {{ ('Sim' if system_facts != {} else 'NÃ£o').ljust(25) }} â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    - name: ğŸ’¾ Exportar dados para JSON
      copy:
        content: |
          {
            "host_info": {{ target_host_data | to_nice_json }},
            "host_variables": {{ host_variables | to_nice_json }},
            "ansible_facts": {{ system_facts | to_nice_json }},
            "host_groups": {{ awx_host_groups.json.results | to_nice_json }},
            "collection_timestamp": "{{ ansible_date_time.iso8601 }}",
            "awx_inventory_id": "{{ awx_inventory_id }}"
          }
        dest: "/tmp/awx_host_{{ target_host }}_{{ ansible_date_time.epoch }}.json"
      register: json_export

    - name: ğŸ“ Local do arquivo exportado
      debug:
        msg: 
          - "ğŸ’¾ Dados exportados para: {{ json_export.dest }}"
          - "ğŸ“Š Comando para visualizar: jq '.' {{ json_export.dest }}"

    - name: ğŸ› ï¸ Comandos Ãºteis para consulta manual
      debug:
        msg:
          - "ğŸ”§ Comandos AWX CLI Ãºteis:"
          - ""
          - "# Obter variÃ¡veis do host:"
          - "curl -u '{{ awx_username }}:$AWX_PASSWORD' '{{ awx_url }}/api/v2/hosts/{{ target_host_data.id }}/' | jq '.variables'"
          - ""
          - "# Obter facts do host:"
          - "curl -u '{{ awx_username }}:$AWX_PASSWORD' '{{ awx_url }}/api/v2/hosts/{{ target_host_data.id }}/ansible_facts/'"
          - ""
          - "# Listar todos os hosts do inventÃ¡rio:"
          - "curl -u '{{ awx_username }}:$AWX_PASSWORD' '{{ awx_url }}/api/v2/inventories/{{ awx_inventory_id }}/hosts/' | jq '.results[].name'"