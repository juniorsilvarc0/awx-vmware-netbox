---
- name: ğŸ” DEBUG - AWX NetBox Sync Troubleshooting
  hosts: localhost
  gather_facts: true
  vars:
    ansible_connection: local
  
  tasks:
    - name: ğŸ” DEBUG - Mostrar todas as variÃ¡veis de ambiente
      debug:
        msg:
          - "=========================================="
          - "ğŸ“Š INFORMAÃ‡Ã•ES DO AMBIENTE AWX"
          - "=========================================="
          - "ğŸ”§ AWX Job ID: {{ tower_job_id | default('N/A') }}"
          - "ğŸ“‹ Job Template: {{ tower_job_template_name | default('N/A') }}"
          - "ğŸ‘¤ UsuÃ¡rio: {{ tower_user_name | default('N/A') }}"
          - "ğŸ“¦ Projeto: {{ tower_project_name | default('N/A') }}"
          - "ğŸ—‚ï¸  InventÃ¡rio: {{ tower_inventory_name | default('N/A') }}"
          - "ğŸ”— AWX Host: {{ tower_host | default('N/A') }}"
          - "=========================================="

    - name: ğŸ” DEBUG - Verificar variÃ¡veis NetBox
      debug:
        msg:
          - "=========================================="
          - "ğŸŒ CONFIGURAÃ‡Ã•ES NETBOX"
          - "=========================================="
          - "ğŸ”— NetBox URL definida: {{ netbox_api_url is defined }}"
          - "ğŸ”— NetBox URL: {{ netbox_api_url | default('NÃƒO DEFINIDA') }}"
          - "ğŸ”‘ NetBox Token definido: {{ netbox_api_token is defined }}"
          - "ğŸ”‘ NetBox Token (primeiros 10 chars): {{ netbox_api_token[:10] if netbox_api_token is defined else 'NÃƒO DEFINIDO' }}"
          - "=========================================="

    - name: ğŸ” DEBUG - Verificar variÃ¡veis extras
      debug:
        msg:
          - "=========================================="
          - "âš™ï¸  EXTRA VARIABLES"
          - "=========================================="
          - "ğŸ¢ Datacenter: {{ awx_netbox_datacenter | default('ATI-SLC-HCI') }}"
          - "ğŸ™ï¸  Tenant: {{ awx_netbox_tenant | default('ATI') }}"
          - "ğŸ‘¤ VM Role: {{ awx_netbox_vm_role | default('server') }}"
          - "ğŸŒ Subnet: {{ awx_netbox_subnet | default('24') }}"
          - "ğŸ”§ Debug habilitado: {{ awx_netbox_debug | default(false) }}"
          - "=========================================="

    - name: ğŸ” DEBUG - Verificar inventÃ¡rio
      debug:
        msg:
          - "=========================================="
          - "ğŸ“‹ INFORMAÃ‡Ã•ES DO INVENTÃRIO"
          - "=========================================="
          - "ğŸ“Š Total de grupos: {{ groups | length }}"
          - "ğŸ“Š Grupos disponÃ­veis: {{ groups.keys() | list }}"
          - "ğŸ“Š Total hosts em 'all': {{ groups['all'] | length if 'all' in groups else 0 }}"
          - "ğŸ–¥ï¸  Primeiros 5 hosts: {{ groups['all'][:5] if 'all' in groups and groups['all'] | length > 0 else 'Nenhum host encontrado' }}"
          - "=========================================="

    - name: ğŸ” DEBUG - Verificar collections instaladas
      shell: |
        ansible-galaxy collection list | grep -E "(netbox|community.vmware)" || echo "Collections nÃ£o encontradas"
      register: collections_check
      ignore_errors: true

    - name: ğŸ” DEBUG - Mostrar collections
      debug:
        msg:
          - "=========================================="
          - "ğŸ“¦ ANSIBLE COLLECTIONS"
          - "=========================================="
          - "{{ collections_check.stdout_lines }}"
          - "=========================================="

    - name: ğŸ” DEBUG - Teste de conectividade (se credenciais estÃ£o definidas)
      uri:
        url: "{{ netbox_api_url }}/api/status/"
        method: GET
        headers:
          Authorization: "Token {{ netbox_api_token }}"
        validate_certs: false
        timeout: 10
      register: netbox_status
      when: 
        - netbox_api_url is defined
        - netbox_api_token is defined
        - netbox_api_url != ''
        - netbox_api_token != ''
      ignore_errors: true

    - name: ğŸ” DEBUG - Resultado do teste NetBox
      debug:
        msg:
          - "=========================================="
          - "ğŸŒ TESTE DE CONECTIVIDADE NETBOX"
          - "=========================================="
          - "âœ… Status: {{ netbox_status.status | default('NÃ£o testado - credenciais faltando') }}"
          - "ğŸ“„ Resposta: {{ netbox_status.json | default('N/A') }}"
          - "âŒ Erro: {{ netbox_status.msg | default('Nenhum') }}"
          - "=========================================="

    - name: ğŸ” DEBUG - Verificar arquivo requirements.yml
      stat:
        path: "{{ playbook_dir }}/../requirements.yml"
      register: requirements_file

    - name: ğŸ” DEBUG - Mostrar requirements.yml
      debug:
        msg:
          - "=========================================="
          - "ğŸ“‹ REQUIREMENTS.YML"
          - "=========================================="
          - "ğŸ“ Arquivo existe: {{ requirements_file.stat.exists }}"
          - "ğŸ“ Caminho: {{ playbook_dir }}/../requirements.yml"
          - "=========================================="

    - name: ğŸ” DEBUG - Verificar versÃ£o do Ansible
      shell: ansible --version
      register: ansible_version

    - name: ğŸ” DEBUG - InformaÃ§Ãµes do sistema
      debug:
        msg:
          - "=========================================="
          - "ğŸ–¥ï¸  INFORMAÃ‡Ã•ES DO SISTEMA"
          - "=========================================="
          - "ğŸ Python: {{ ansible_python_interpreter | default(ansible_python.executable) }}"
          - "ğŸ“¦ Ansible: {{ ansible_version.stdout_lines[0] }}"
          - "ğŸ—‚ï¸  Playbook Dir: {{ playbook_dir }}"
          - "ğŸ  Home Dir: {{ ansible_env.HOME | default('N/A') }}"
          - "ğŸ‘¤ User: {{ ansible_env.USER | default('N/A') }}"
          - "=========================================="

    - name: ğŸ” DEBUG - Verificar se existem VMs vÃ¡lidas no inventÃ¡rio
      debug:
        msg:
          - "=========================================="
          - "ğŸ–¥ï¸  ANÃLISE DO INVENTÃRIO DE VMS"
          - "=========================================="
          - "ğŸ“Š Verificando hostvars..."
      delegate_to: localhost

- name: ğŸ” DEBUG - Verificar hosts individuais (amostra)
  hosts: all
  gather_facts: false
  vars:
    ansible_connection: local
  serial: 5  # Processa apenas 5 hosts para debug
  
  tasks:
    - name: ğŸ” DEBUG - InformaÃ§Ãµes do host atual
      debug:
        msg:
          - "=========================================="
          - "ğŸ–¥ï¸  HOST: {{ inventory_hostname }}"
          - "=========================================="
          - "ğŸ“› vm_name: {{ vm_name | default('NÃƒO DEFINIDO') }}"
          - "âš¡ vm_power_state: {{ vm_power_state | default('NÃƒO DEFINIDO') }}"
          - "ğŸŒ vm_ip_addresses: {{ vm_ip_addresses | default('NÃƒO DEFINIDO') }}"
          - "ğŸ’» vm_guest_os: {{ vm_guest_os | default('NÃƒO DEFINIDO') }}"
          - "ğŸ¢ vm_cluster: {{ vm_cluster | default('NÃƒO DEFINIDO') }}"
          - "ğŸ“Š vm_cpu_count: {{ vm_cpu_count | default('NÃƒO DEFINIDO') }}"
          - "ğŸ§  vm_memory_mb: {{ vm_memory_mb | default('NÃƒO DEFINIDO') }}"
          - "ğŸ·ï¸  vm_environment: {{ vm_environment | default('NÃƒO DEFINIDO') }}"
          - "ğŸ”´ vm_criticality: {{ vm_criticality | default('NÃƒO DEFINIDO') }}"
          - "âœ… Ã‰ VM vÃ¡lida: {{ vm_name is defined and vm_name != 'localhost' and vm_name != inventory_hostname and vm_name != 'N/A' and vm_name != '' }}"
          - "=========================================="
      when: ansible_play_hosts.index(inventory_hostname) < 5  # Apenas primeiros 5 hosts

- name: ğŸ” DEBUG - Resumo Final
  hosts: localhost
  gather_facts: false
  vars:
    ansible_connection: local
    
  tasks:
    - name: ğŸ” DEBUG - Resumo da anÃ¡lise
      debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘                    ğŸ” RESUMO DO DEBUG                           â•‘"
          - "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          - "â•‘ 1. Verifique se as credenciais NetBox estÃ£o configuradas        â•‘"
          - "â•‘ 2. Confirme que o inventÃ¡rio VMware estÃ¡ populado               â•‘"
          - "â•‘ 3. Verifique se as collections estÃ£o instaladas                 â•‘"
          - "â•‘ 4. Confirme conectividade com NetBox                            â•‘"
          - "â•‘                                                                  â•‘"
          - "â•‘ ğŸ“‹ PrÃ³ximos passos baseados nos resultados acima:               â•‘"
          - "â•‘ - Se credenciais faltam: Configure Custom Credential Type       â•‘"
          - "â•‘ - Se inventory vazio: Verifique fonte VMware                    â•‘"
          - "â•‘ - Se collections faltam: requirements.yml serÃ¡ processado       â•‘"
          - "â•‘ - Se NetBox inacessÃ­vel: Verifique URL e token                  â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    - name: ğŸ“ DEBUG - Gerar arquivo de diagnÃ³stico
      copy:
        content: |
          DIAGNÃ“STICO AWX â†’ NetBox Sync
          ==============================
          
          Data/Hora: {{ ansible_date_time.iso8601 }}
          AWX Job ID: {{ tower_job_id | default('N/A') }}
          Job Template: {{ tower_job_template_name | default('N/A') }}
          
          CREDENCIAIS:
          - NetBox URL definida: {{ netbox_api_url is defined }}
          - NetBox Token definido: {{ netbox_api_token is defined }}
          
          INVENTÃRIO:
          - Total de hosts: {{ groups['all'] | length if 'all' in groups else 0 }}
          - Grupos disponÃ­veis: {{ groups.keys() | join(', ') }}
          
          VARIÃVEIS EXTRAS:
          - Datacenter: {{ awx_netbox_datacenter | default('ATI-SLC-HCI') }}
          - Tenant: {{ awx_netbox_tenant | default('ATI') }}
          - VM Role: {{ awx_netbox_vm_role | default('server') }}
          - Debug: {{ awx_netbox_debug | default(false) }}
          
          STATUS NETBOX:
          - Conectividade: {{ 'OK' if netbox_status is defined and netbox_status.status == 200 else 'FALHOU' }}
          - Status Code: {{ netbox_status.status | default('N/A') }}
          
          RECOMENDAÃ‡Ã•ES:
          {% if not (netbox_api_url is defined and netbox_api_token is defined) %}
          âš ï¸  CRÃTICO: Credenciais NetBox nÃ£o configuradas
             - Crie Custom Credential Type "NetBox API" 
             - Adicione credencial ao Job Template
          {% endif %}
          
          {% if groups['all'] | length == 0 %}
          âš ï¸  CRÃTICO: InventÃ¡rio vazio
             - Verifique fonte de inventÃ¡rio VMware
             - Confirme que dynamic inventory estÃ¡ funcionando
          {% endif %}
          
        dest: /tmp/awx_netbox_debug_{{ tower_job_id | default('manual') }}.txt
      ignore_errors: true