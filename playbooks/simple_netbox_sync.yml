---
- name: ğŸš€ AWX â†’ NetBox Sync (VersÃ£o Simplificada)
  hosts: all
  gather_facts: false
  vars:
    ansible_connection: local
    
    # ConfiguraÃ§Ãµes NetBox - usando variÃ¡veis de credential ou env
    netbox_url: "{{ netbox_api_url | default(lookup('env', 'NETBOX_API') | default('http://177.93.133.239:8000')) }}"
    netbox_token: "{{ netbox_api_token | default(lookup('env', 'NETBOX_TOKEN') | default('')) }}"
    
    # ConfiguraÃ§Ãµes padrÃ£o
    datacenter_name: "{{ awx_netbox_datacenter | default('ATI-SLC-HCI') }}"
    tenant_name: "{{ awx_netbox_tenant | default('ATI') }}"
    vm_role: "{{ awx_netbox_vm_role | default('server') }}"
    default_ip_subnet: "{{ awx_netbox_subnet | default('24') }}"
    enable_debug: "{{ awx_netbox_debug | default(true) }}"
    
    # Controle de execuÃ§Ã£o
    max_vms_to_process: "{{ awx_netbox_max_vms | default(10) }}"  # Limite para teste
    
    # EstatÃ­sticas
    processed_count: 0
    success_count: 0
    failed_count: 0

  tasks:
    # ğŸ¯ Header de inicializaÃ§Ã£o
    - name: ğŸ¯ Inicializar sincronizaÃ§Ã£o AWX â†’ NetBox
      debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘              ğŸš€ AWX â†’ NetBox Sync (VersÃ£o Simples)              â•‘"
          - "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          - "â•‘ ğŸ• InÃ­cio: {{ ansible_date_time.iso8601 }}                      â•‘"
          - "â•‘ ğŸ¢ Tenant: {{ tenant_name }}                                    â•‘"
          - "â•‘ ğŸ—ï¸  Site: {{ datacenter_name }}                                â•‘"
          - "â•‘ ğŸ¯ NetBox: {{ netbox_url }}                                     â•‘"
          - "â•‘ ğŸ“Š Host atual: {{ inventory_hostname }}                         â•‘"
          - "â•‘ ğŸ”§ Debug: {{ enable_debug }}                                    â•‘"
          - "â•‘ ğŸ”¢ Limite VMs: {{ max_vms_to_process }}                         â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
      run_once: true

    # ğŸ” Verificar configuraÃ§Ã£o bÃ¡sica
    - name: ğŸ” Verificar configuraÃ§Ã£o
      debug:
        msg:
          - "âš™ï¸  Verificando configuraÃ§Ã£o..."
          - "ğŸ”— NetBox URL: {{ 'CONFIGURADA' if netbox_url != '' else 'âŒ FALTANDO' }}"
          - "ğŸ”‘ NetBox Token: {{ 'CONFIGURADO' if netbox_token != '' else 'âŒ FALTANDO' }}"
          - "ğŸ“‹ Inventory Host: {{ inventory_hostname }}"
          - "ğŸ–¥ï¸  VM Name: {{ vm_name | default('âŒ NÃƒO DEFINIDO') }}"
      when: enable_debug
      run_once: true

    # âš ï¸ ValidaÃ§Ã£o crÃ­tica
    - name: âš ï¸ Validar configuraÃ§Ã£o crÃ­tica
      fail:
        msg: |
          âŒ CONFIGURAÃ‡ÃƒO INVÃLIDA:
          
          NetBox URL: {{ netbox_url }}
          NetBox Token: {{ 'DEFINIDO' if netbox_token != '' else 'FALTANDO' }}
          
          SOLUÃ‡Ã•ES:
          1. Configure Custom Credential Type "NetBox API" no AWX
          2. Adicione as credenciais no Job Template
          3. OU configure as variÃ¡veis NETBOX_API e NETBOX_TOKEN
      when: netbox_url == '' or netbox_token == ''
      run_once: true

    # ğŸ” Verificar se Ã© uma VM vÃ¡lida
    - name: ğŸ” Verificar se Ã© uma VM vÃ¡lida
      set_fact:
        is_valid_vm: >-
          {{
            vm_name is defined and 
            vm_name != 'localhost' and 
            vm_name != inventory_hostname and 
            vm_name != 'N/A' and 
            vm_name != '' and
            vm_name is not none
          }}

    # ğŸ“Š Debug das informaÃ§Ãµes da VM
    - name: ğŸ“Š Debug - InformaÃ§Ãµes da VM
      debug:
        msg:
          - "ğŸ–¥ï¸  Host: {{ inventory_hostname }}"
          - "ğŸ“› VM Name: {{ vm_name | default('NÃƒO DEFINIDO') }}"
          - "âœ… Ã‰ vÃ¡lida: {{ is_valid_vm }}"
          - "âš¡ Power State: {{ vm_power_state | default('N/A') }}"
          - "ğŸŒ IPs: {{ vm_ip_addresses | default([]) | join(', ') }}"
          - "ğŸ’» OS: {{ vm_guest_os | default('N/A') }}"
          - "ğŸ¢ Cluster: {{ vm_cluster | default('N/A') }}"
          - "ğŸ“Š CPUs: {{ vm_cpu_count | default('N/A') }}"
          - "ğŸ§  Memory: {{ vm_memory_mb | default('N/A') }}MB"
      when: 
        - enable_debug
        - ansible_play_hosts.index(inventory_hostname) < 5  # Apenas primeiros 5 para debug

    # â­ï¸ Pular VMs invÃ¡lidas
    - name: â­ï¸ Pular VM invÃ¡lida
      meta: end_host
      when: not is_valid_vm

    # ğŸ“Š Contar VM vÃ¡lida
    - name: ğŸ“Š Incrementar contador
      set_fact:
        processed_count: "{{ processed_count | int + 1 }}"

    # ğŸ›‘ Limitar processamento para teste
    - name: ğŸ›‘ Limitar processamento para teste
      meta: end_host
      when: processed_count | int > max_vms_to_process | int

    # ğŸ§ª Teste de conectividade NetBox (apenas uma vez)
    - name: ğŸ§ª Testar conectividade NetBox
      uri:
        url: "{{ netbox_url }}/api/status/"
        method: GET
        headers:
          Authorization: "Token {{ netbox_token }}"
        validate_certs: false
        timeout: 10
        status_code: 200
      register: netbox_connectivity
      run_once: true
      delegate_to: localhost
      ignore_errors: true

    # ğŸ“Š Resultado do teste
    - name: ğŸ“Š Resultado do teste NetBox
      debug:
        msg:
          - "ğŸŒ Teste de conectividade NetBox:"
          - "{{ 'âœ… SUCESSO' if netbox_connectivity.status == 200 else 'âŒ FALHOU' }}"
          - "ğŸ“Š Status: {{ netbox_connectivity.status | default('ERRO') }}"
          - "ğŸ“„ Resposta: {{ netbox_connectivity.json.netbox_version | default('N/A') if netbox_connectivity.status == 200 else netbox_connectivity.msg | default('Erro desconhecido') }}"
      run_once: true
      when: enable_debug

    # âš ï¸ Parar se NetBox inacessÃ­vel
    - name: âš ï¸ Falha na conectividade NetBox
      fail:
        msg: |
          âŒ FALHA NA CONECTIVIDADE NETBOX:
          
          URL: {{ netbox_url }}
          Status: {{ netbox_connectivity.status | default('ERRO') }}
          Erro: {{ netbox_connectivity.msg | default('Timeout ou erro de rede') }}
          
          VERIFIQUE:
          1. URL do NetBox estÃ¡ correta
          2. Token de API estÃ¡ vÃ¡lido
          3. NetBox estÃ¡ acessÃ­vel da rede AWX
          4. Firewall/proxy nÃ£o estÃ¡ bloqueando
      when: 
        - netbox_connectivity.status != 200
        - netbox_connectivity is defined
      run_once: true

    # ğŸ¢ Criar tenant (usando mÃ³dulo bÃ¡sico primeiro)
    - name: ğŸ¢ Criar tenant NetBox
      uri:
        url: "{{ netbox_url }}/api/tenancy/tenants/"
        method: POST
        headers:
          Authorization: "Token {{ netbox_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          name: "{{ tenant_name }}"
          slug: "{{ tenant_name | lower }}"
        validate_certs: false
        status_code: [200, 201, 400]  # 400 = jÃ¡ existe
      register: tenant_result
      run_once: true
      delegate_to: localhost
      ignore_errors: true

    # ğŸ“Š Debug resultado tenant
    - name: ğŸ“Š Debug - Resultado criaÃ§Ã£o tenant
      debug:
        msg:
          - "ğŸ¢ CriaÃ§Ã£o do tenant '{{ tenant_name }}':"
          - "ğŸ“Š Status: {{ tenant_result.status }}"
          - "{{ 'âœ… Criado' if tenant_result.status == 201 else 'âœ… JÃ¡ existe' if tenant_result.status == 400 else 'âŒ Erro' }}"
          - "ğŸ“„ Resposta: {{ tenant_result.json.name | default('N/A') if tenant_result.status in [200, 201] else tenant_result.json.name[0] | default('Erro') if tenant_result.status == 400 else 'Erro desconhecido' }}"
      run_once: true
      when: enable_debug

    # ğŸ—ï¸ Criar site
    - name: ğŸ—ï¸ Criar site NetBox
      uri:
        url: "{{ netbox_url }}/api/dcim/sites/"
        method: POST
        headers:
          Authorization: "Token {{ netbox_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          name: "{{ datacenter_name }}"
          slug: "{{ datacenter_name | lower | replace('_', '-') }}"
          status: "active"
        validate_certs: false
        status_code: [200, 201, 400]
      register: site_result
      run_once: true
      delegate_to: localhost
      ignore_errors: true

    # ğŸ“Š Debug resultado site
    - name: ğŸ“Š Debug - Resultado criaÃ§Ã£o site
      debug:
        msg:
          - "ğŸ—ï¸  CriaÃ§Ã£o do site '{{ datacenter_name }}':"
          - "ğŸ“Š Status: {{ site_result.status }}"
          - "{{ 'âœ… Criado' if site_result.status == 201 else 'âœ… JÃ¡ existe' if site_result.status == 400 else 'âŒ Erro' }}"
      run_once: true
      when: enable_debug

    # ğŸ’» Tentar criar VM usando API direta
    - name: "ğŸ’» Criar/Atualizar VM {{ vm_name }} no NetBox"
      uri:
        url: "{{ netbox_url }}/api/virtualization/virtual-machines/"
        method: POST
        headers:
          Authorization: "Token {{ netbox_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          name: "{{ vm_name }}"
          status: "{{ 'active' if vm_power_state == 'poweredOn' else 'offline' }}"
          vcpus: "{{ vm_cpu_count | default(1) | int }}"
          memory: "{{ vm_memory_mb | default(1024) | int }}"
          comments: |
            Sincronizado via AWX Job Template
            Host: {{ inventory_hostname }}
            Job: {{ tower_job_id | default('N/A') }}
            Data: {{ ansible_date_time.iso8601 }}
            
            Detalhes:
            - Power State: {{ vm_power_state | default('N/A') }}
            - Guest OS: {{ vm_guest_os | default('N/A') }}
            - Cluster: {{ vm_cluster | default('N/A') }}
            - IPs: {{ vm_ip_addresses | default([]) | join(', ') }}
        validate_certs: false
        status_code: [200, 201, 400]
      register: vm_result
      delegate_to: localhost
      ignore_errors: true

    # âœ… Resultado da criaÃ§Ã£o da VM
    - name: "âœ… Resultado da VM {{ vm_name }}"
      debug:
        msg:
          - "ğŸ–¥ï¸  VM: {{ vm_name }}"
          - "ğŸ“Š Status HTTP: {{ vm_result.status }}"
          - "{{ 'âœ… CRIADA' if vm_result.status == 201 else 'âœ… JÃ EXISTE' if vm_result.status == 400 else 'âŒ ERRO' }}"
          - "ğŸ’¾ ID NetBox: {{ vm_result.json.id | default('N/A') if vm_result.status == 201 else 'N/A' }}"
          - "âŒ Erro: {{ vm_result.json | default('N/A') if vm_result.status not in [200, 201] else 'Nenhum' }}"
      when: enable_debug

    # ğŸ“Š Atualizar estatÃ­sticas
    - name: ğŸ“Š Atualizar contador de sucesso
      set_fact:
        success_count: "{{ success_count | int + 1 }}"
      when: vm_result.status in [200, 201]

    - name: ğŸ“Š Atualizar contador de falhas
      set_fact:
        failed_count: "{{ failed_count | int + 1 }}"
      when: vm_result.status not in [200, 201]

# ğŸ“Š RelatÃ³rio final
- name: ğŸ“Š RelatÃ³rio Final
  hosts: localhost
  gather_facts: false
  vars:
    ansible_connection: local
    
  tasks:
    - name: ğŸ“ˆ Coletar estatÃ­sticas finais
      set_fact:
        total_hosts: "{{ groups['all'] | length }}"
        final_time: "{{ ansible_date_time.iso8601 }}"

    - name: ğŸš€ RelatÃ³rio Final da SincronizaÃ§Ã£o
      debug:
        msg:
          - "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          - "â•‘                    ğŸ“Š RELATÃ“RIO FINAL                           â•‘"
          - "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
          - "â•‘ ğŸ• ConcluÃ­do: {{ final_time }}                                  â•‘"
          - "â•‘ ğŸ“Š Total de hosts no inventÃ¡rio: {{ total_hosts }}              â•‘"
          - "â•‘ ğŸ–¥ï¸  VMs processadas: {{ hostvars | dict2items | selectattr('value.processed_count', 'defined') | list | length }}                       â•‘"
          - "â•‘ âœ… Sucessos: {{ hostvars | dict2items | selectattr('value.success_count', 'defined') | map(attribute='value.success_count') | map('int') | sum }}                            â•‘"
          - "â•‘ âŒ Falhas: {{ hostvars | dict2items | selectattr('value.failed_count', 'defined') | map(attribute='value.failed_count') | map('int') | sum }}                             â•‘"
          - "â•‘ ğŸ¯ NetBox: {{ netbox_url }}                                     â•‘"
          - "â•‘ ğŸ¢ Tenant: {{ tenant_name }}                                    â•‘"
          - "â•‘ ğŸ—ï¸  Site: {{ datacenter_name }}                                â•‘"
          - "â•‘                                                                  â•‘"
          - "â•‘ ğŸ’¡ PRÃ“XIMOS PASSOS:                                             â•‘"
          - "â•‘ 1. Se funcionou: Aumente max_vms_to_process                     â•‘"
          - "â•‘ 2. Configure schedule para execuÃ§Ã£o automÃ¡tica                  â•‘"
          - "â•‘ 3. Use playbook completo: awx_job_template_sync.yml             â•‘"
          - "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

    - name: ğŸ“ Gerar arquivo de relatÃ³rio
      copy:
        content: |
          AWX â†’ NetBox Sync - RelatÃ³rio de ExecuÃ§Ã£o
          ==========================================
          
          Data/Hora: {{ final_time }}
          AWX Job ID: {{ tower_job_id | default('N/A') }}
          Job Template: {{ tower_job_template_name | default('N/A') }}
          UsuÃ¡rio: {{ tower_user_name | default('N/A') }}
          
          CONFIGURAÃ‡ÃƒO:
          - NetBox URL: {{ netbox_url }}
          - Tenant: {{ tenant_name }}
          - Site: {{ datacenter_name }}
          - VM Role: {{ vm_role }}
          - Debug habilitado: {{ enable_debug }}
          - Limite de VMs: {{ max_vms_to_process }}
          
          RESULTADOS:
          - Total hosts no inventÃ¡rio: {{ total_hosts }}
          - VMs processadas: {{ hostvars | dict2items | selectattr('value.processed_count', 'defined') | list | length }}
          - Sucessos: {{ hostvars | dict2items | selectattr('value.success_count', 'defined') | map(attribute='value.success_count') | map('int') | sum }}
          - Falhas: {{ hostvars | dict2items | selectattr('value.failed_count', 'defined') | map(attribute='value.failed_count') | map('int') | sum }}
          
          STATUS:
          {% if (hostvars | dict2items | selectattr('value.success_count', 'defined') | map(attribute='value.success_count') | map('int') | sum) > 0 %}
          âœ… SUCESSO - Pelo menos uma VM foi sincronizada
          {% else %}
          âŒ FALHA - Nenhuma VM foi sincronizada
          {% endif %}
          
          RECOMENDAÃ‡Ã•ES:
          - Se funcionou com limite pequeno, aumente max_vms_to_process
          - Configure execuÃ§Ã£o programada no AWX
          - Use o playbook completo awx_job_template_sync.yml para produÃ§Ã£o
          
        dest: /tmp/awx_netbox_sync_report_{{ tower_job_id | default('manual') }}.txt
      ignore_errors: true