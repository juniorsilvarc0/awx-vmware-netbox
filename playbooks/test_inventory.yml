---
# Playbook para gerar relatÃ³rios do inventÃ¡rio VMware - SOMENTE LEITURA
# Arquivo: playbooks/inventory_report.yml

- name: ğŸ” RelatÃ³rio do InventÃ¡rio VMware - VisÃ£o Geral
  hosts: all
  gather_facts: false
  vars:
    ansible_connection: local

  tasks:
    - name: ğŸ“Š Exibir informaÃ§Ãµes da VM
      debug:
        msg: |
          =====================================
          ğŸ“‹ INVENTÃRIO VMWARE - {{ vm_name | default('N/A') }}
          =====================================
          ğŸ†” UUID: {{ vm_uuid | default('N/A') }}
          âš¡ Estado: {{ vm_power_state | default('N/A') }}
          ğŸ’» SO: {{ vm_guest_os | default('N/A') }}
          ğŸ¢ Datacenter: {{ vm_datacenter | default('N/A') }}
          ğŸ—ï¸  Cluster: {{ vm_cluster | default('N/A') }}
          ğŸ“ Pasta: {{ vm_folder | default('N/A') }}
          ğŸ”§ CPU: {{ vm_cpu_count | default('N/A') }} cores ({{ vm_cpu_category | default('N/A') }})
          ğŸ’¾ MemÃ³ria: {{ vm_memory_gb | default('N/A') }} GB ({{ vm_memory_category | default('N/A') }})
          ğŸŒ IP: {{ vm_ip_addresses | default('N/A') }}
          ğŸ–¥ï¸  Hostname: {{ vm_hostname | default('N/A') }}
          ğŸ› ï¸  VMware Tools: {{ vm_tools_status | default('N/A') }}
          ğŸ“‚ Datastores: {{ vm_datastores | default('N/A') }}
          ğŸ”— Redes: {{ vm_networks | default('N/A') }}
          ğŸ“¸ Snapshots: {{ vm_snapshot_count | default(0) }}
          ğŸ“ AnotaÃ§Ã£o: {{ vm_annotation | default('N/A') }}
          ğŸ·ï¸  Ambiente: {{ vm_environment | default('N/A') }}
          ğŸ“ˆ Criticidade: {{ vm_criticality | default('N/A') }}
          =====================================

- name: ğŸ“ˆ EstatÃ­sticas - VMs por Estado de Energia
  hosts: localhost
  gather_facts: false
  run_once: true
  vars:
    ansible_connection: local

  tasks:
    - name: ğŸ“Š Resumo por estado de energia
      debug:
        msg: |
          âš¡ ESTATÃSTICAS POR ESTADO DE ENERGIA
          âœ… VMs Ligadas: {{ groups['powered_on'] | default([]) | length }}
          âŒ VMs Desligadas: {{ groups['powered_off'] | default([]) | length }}
          â¸ï¸  VMs Suspensas: {{ groups['suspended'] | default([]) | length }}

- name: ğŸ–¥ï¸ EstatÃ­sticas - VMs por Sistema Operacional
  hosts: localhost
  gather_facts: false
  run_once: true
  vars:
    ansible_connection: local

  tasks:
    - name: ğŸ“Š Resumo por SO
      debug:
        msg: |
          ğŸ–¥ï¸  ESTATÃSTICAS POR SISTEMA OPERACIONAL
          ğŸªŸ VMs Windows: {{ groups['windows'] | default([]) | length }}
          â”‚  â”œâ”€ Windows Server: {{ groups['windows_server'] | default([]) | length }}
          â”‚  â””â”€ Windows Desktop: {{ groups['windows_desktop'] | default([]) | length }}
          ğŸ§ VMs Linux: {{ groups['linux'] | default([]) | length }}
          â”‚  â”œâ”€ Ubuntu: {{ groups['ubuntu'] | default([]) | length }}
          â”‚  â”œâ”€ CentOS: {{ groups['centos'] | default([]) | length }}
          â”‚  â”œâ”€ Red Hat: {{ groups['redhat'] | default([]) | length }}
          â”‚  â””â”€ SUSE: {{ groups['suse'] | default([]) | length }}

- name: âš¡ EstatÃ­sticas - VMs por Recursos
  hosts: localhost
  gather_facts: false
  run_once: true
  vars:
    ansible_connection: local

  tasks:
    - name: ğŸ“Š Resumo por recursos
      debug:
        msg: |
          âš¡ ESTATÃSTICAS POR RECURSOS
          ğŸ”§ CPU:
          â”‚  â”œâ”€ Alto (8+ cores): {{ groups['high_cpu'] | default([]) | length }}
          â”‚  â”œâ”€ MÃ©dio (4-7 cores): {{ groups['medium_cpu'] | default([]) | length }}
          â”‚  â””â”€ Baixo (<4 cores): {{ groups['low_cpu'] | default([]) | length }}
          ğŸ’¾ MemÃ³ria:
          â”‚  â”œâ”€ Alta (16+ GB): {{ groups['high_memory'] | default([]) | length }}
          â”‚  â”œâ”€ MÃ©dia (8-15 GB): {{ groups['medium_memory'] | default([]) | length }}
          â”‚  â”œâ”€ Baixa (4-7 GB): {{ groups['low_memory'] | default([]) | length }}
          â”‚  â””â”€ MÃ­nima (<4 GB): {{ groups['minimal_memory'] | default([]) | length }}
          ğŸš€ Alto Desempenho: {{ groups['high_performance'] | default([]) | length }}

- name: ğŸ› ï¸ EstatÃ­sticas - VMware Tools
  hosts: localhost
  gather_facts: false
  run_once: true
  vars:
    ansible_connection: local

  tasks:
    - name: ğŸ“Š Status VMware Tools
      debug:
        msg: |
          ğŸ› ï¸  ESTATÃSTICAS VMWARE TOOLS
          âœ… Tools OK: {{ groups['tools_ok'] | default([]) | length }}
          âš ï¸  Tools Desatualizadas: {{ groups['tools_outdated'] | default([]) | length }}
          âŒ Tools NÃ£o Instaladas: {{ groups['tools_not_installed'] | default([]) | length }}
          ğŸ”´ Tools NÃ£o Executando: {{ groups['tools_not_running'] | default([]) | length }}

- name: ğŸ“¸ EstatÃ­sticas - Snapshots
  hosts: localhost
  gather_facts: false
  run_once: true
  vars:
    ansible_connection: local

  tasks:
    - name: ğŸ“Š Status de snapshots
      debug:
        msg: |
          ğŸ“¸ ESTATÃSTICAS DE SNAPSHOTS
          âœ… VMs com Snapshots: {{ groups['has_snapshots'] | default([]) | length }}
          ğŸ“š VMs com MÃºltiplos Snapshots: {{ groups['multiple_snapshots'] | default([]) | length }}
          ğŸ”´ VMs sem Snapshots: {{ groups['no_snapshots'] | default([]) | length }}

- name: ğŸŒ EstatÃ­sticas - Ambientes
  hosts: localhost
  gather_facts: false
  run_once: true
  vars:
    ansible_connection: local

  tasks:
    - name: ğŸ“Š VMs por ambiente
      debug:
        msg: |
          ğŸŒ ESTATÃSTICAS POR AMBIENTE
          ğŸ­ ProduÃ§Ã£o: {{ groups['production'] | default([]) | length }}
          ğŸ§ª Desenvolvimento: {{ groups['development'] | default([]) | length }}
          ğŸ”¬ Teste: {{ groups['testing'] | default([]) | length }}
          ğŸ­ Staging: {{ groups['staging'] | default([]) | length }}

- name: âš ï¸ VMs que Precisam de AtenÃ§Ã£o
  hosts: needs_attention
  gather_facts: false
  vars:
    ansible_connection: local

  tasks:
    - name: ğŸš¨ Listar VMs problemÃ¡ticas
      debug:
        msg: |
          âš ï¸  VM PRECISA DE ATENÃ‡ÃƒO: {{ vm_name }}
          Motivos:
          {% if vm_tools_status != 'toolsOk' %}  â€¢ VMware Tools: {{ vm_tools_status }}{% endif %}
          {% if vm_power_state == 'poweredOff' %}  â€¢ Estado: VM Desligada{% endif %}
          {% if vm_snapshot_count > 5 %}  â€¢ Muitos Snapshots: {{ vm_snapshot_count }}{% endif %}
      when: vm_tools_status != 'toolsOk' or vm_power_state == 'poweredOff' or vm_snapshot_count > 5

- name: ğŸ“‹ RelatÃ³rio Executivo Final
  hosts: localhost
  gather_facts: true
  run_once: true
  vars:
    ansible_connection: local

  tasks:
    - name: ğŸ“Š Gerar resumo executivo completo
      debug:
        msg: |

          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘           RESUMO EXECUTIVO VMWARE            â•‘
          â•‘              INVENTÃRIO COMPLETO             â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘ ğŸ“Š TOTAIS GERAIS                             â•‘
          â•‘   â€¢ Total de VMs: {{ groups['all'] | length }}                           â•‘
          â•‘   â€¢ VMs Ativas: {{ groups['powered_on'] | default([]) | length }}                            â•‘
          â•‘   â€¢ VMs Inativas: {{ groups['powered_off'] | default([]) | length }}                         â•‘
          â•‘   â€¢ VMs Suspensas: {{ groups['suspended'] | default([]) | length }}                          â•‘
          â•‘                                              â•‘
          â•‘ ğŸ–¥ï¸  SISTEMAS OPERACIONAIS                    â•‘
          â•‘   â€¢ Windows: {{ groups['windows'] | default([]) | length }}                               â•‘
          â•‘   â€¢ Linux: {{ groups['linux'] | default([]) | length }}                                 â•‘
          â•‘                                              â•‘
          â•‘ âš¡ RECURSOS                                   â•‘
          â•‘   â€¢ Alto CPU (8+): {{ groups['high_cpu'] | default([]) | length }}                       â•‘
          â•‘   â€¢ Alta MemÃ³ria (16GB+): {{ groups['high_memory'] | default([]) | length }}              â•‘
          â•‘   â€¢ Alto Desempenho: {{ groups['high_performance'] | default([]) | length }}              â•‘
          â•‘                                              â•‘
          â•‘ ğŸ› ï¸  VMWARE TOOLS                             â•‘
          â•‘   â€¢ OK: {{ groups['tools_ok'] | default([]) | length }}                                   â•‘
          â•‘   â€¢ Desatualizadas: {{ groups['tools_outdated'] | default([]) | length }}                 â•‘
          â•‘   â€¢ NÃ£o Instaladas: {{ groups['tools_not_installed'] | default([]) | length }}            â•‘
          â•‘                                              â•‘
          â•‘ ğŸŒ AMBIENTES                                 â•‘
          â•‘   â€¢ ProduÃ§Ã£o: {{ groups['production'] | default([]) | length }}                           â•‘
          â•‘   â€¢ Desenvolvimento: {{ groups['development'] | default([]) | length }}                   â•‘
          â•‘   â€¢ Teste: {{ groups['testing'] | default([]) | length }}                                â•‘
          â•‘                                              â•‘
          â•‘ âš ï¸  ATENÃ‡ÃƒO NECESSÃRIA                       â•‘
          â•‘   â€¢ VMs ProblemÃ¡ticas: {{ groups['needs_attention'] | default([]) | length }}             â•‘
          â•‘   â€¢ VMs com Snapshots: {{ groups['has_snapshots'] | default([]) | length }}               â•‘
          â•‘                                              â•‘
          â•‘ ğŸ“… INFORMAÃ‡Ã•ES DO RELATÃ“RIO                  â•‘
          â•‘   â€¢ Data/Hora: {{ ansible_date_time.iso8601 | default('N/A') }}        â•‘
          â•‘   â€¢ Modo: Somente Leitura                   â•‘
          â•‘   â€¢ Fonte: InventÃ¡rio DinÃ¢mico AWX          â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

- name: ğŸ’¾ Exportar Dados do InventÃ¡rio (JSON)
  hosts: localhost
  gather_facts: true
  run_once: true
  vars:
    ansible_connection: local
    export_file: "/tmp/vmware_inventory_{{ ansible_date_time.date }}_{{ ansible_date_time.hour }}{{ ansible_date_time.minute }}.json"

  tasks:
    - name: ğŸ“„ Criar arquivo de exportaÃ§Ã£o
      copy:
        content: |
          {
            "inventory_metadata": {
              "report_timestamp": "{{ ansible_date_time.iso8601 }}",
              "report_type": "vmware_inventory_summary",
              "mode": "read_only",
              "total_vms": {{ groups['all'] | length }}
            },
            "summary_statistics": {
              "power_state": {
                "powered_on": {{ groups['powered_on'] | default([]) | length }},
                "powered_off": {{ groups['powered_off'] | default([]) | length }},
                "suspended": {{ groups['suspended'] | default([]) | length }}
              },
              "operating_systems": {
                "windows_total": {{ groups['windows'] | default([]) | length }},
                "windows_server": {{ groups['windows_server'] | default([]) | length }},
                "windows_desktop": {{ groups['windows_desktop'] | default([]) | length }},
                "linux_total": {{ groups['linux'] | default([]) | length }},
                "ubuntu": {{ groups['ubuntu'] | default([]) | length }},
                "centos": {{ groups['centos'] | default([]) | length }},
                "redhat": {{ groups['redhat'] | default([]) | length }}
              },
              "resources": {
                "high_cpu": {{ groups['high_cpu'] | default([]) | length }},
                "high_memory": {{ groups['high_memory'] | default([]) | length }},
                "high_performance": {{ groups['high_performance'] | default([]) | length }}
              },
              "vmware_tools": {
                "tools_ok": {{ groups['tools_ok'] | default([]) | length }},
                "tools_outdated": {{ groups['tools_outdated'] | default([]) | length }},
                "tools_not_installed": {{ groups['tools_not_installed'] | default([]) | length }}
              },
              "environments": {
                "production": {{ groups['production'] | default([]) | length }},
                "development": {{ groups['development'] | default([]) | length }},
                "testing": {{ groups['testing'] | default([]) | length }},
                "staging": {{ groups['staging'] | default([]) | length }}
              },
              "attention_required": {
                "needs_attention": {{ groups['needs_attention'] | default([]) | length }},
                "has_snapshots": {{ groups['has_snapshots'] | default([]) | length }},
                "multiple_snapshots": {{ groups['multiple_snapshots'] | default([]) | length }}
              }
            },
            "inventory_groups": {{ groups | to_nice_json }}
          }
        dest: "{{ export_file }}"
        mode: "0644"
      delegate_to: localhost

    - name: âœ… ConfirmaÃ§Ã£o de exportaÃ§Ã£o
      debug:
        msg: |
          ğŸ“„ EXPORTAÃ‡ÃƒO CONCLUÃDA
          ========================
          ğŸ“ Arquivo: {{ export_file }}
          ğŸ“Š Dados: InventÃ¡rio completo VMware
          ğŸ• Timestamp: {{ ansible_date_time.iso8601 }}
          ğŸ”’ Modo: Somente Leitura

          ğŸ’¡ Este arquivo contÃ©m um resumo completo do inventÃ¡rio
          e pode ser usado para anÃ¡lises ou relatÃ³rios externos.---
# Playbook de teste para verificar inventÃ¡rio VMware
# Arquivo: playbooks/test_inventory.yml

- name: ğŸ” Teste do InventÃ¡rio VMware - RelatÃ³rio Geral
  hosts: all
  gather_facts: false
  vars:
    ansible_connection: local
    report_timestamp: "{{ ansible_date_time.iso8601 }}"

  tasks:
    - name: ğŸ“Š Gerar relatÃ³rio de inventÃ¡rio
      debug:
        msg: |
          =====================================
          RELATÃ“RIO DE INVENTÃRIO VMWARE
          =====================================
          ğŸ• Timestamp: {{ report_timestamp }}
          ğŸ“‹ VM: {{ vm_name | default('N/A') }}
          ğŸ†” UUID: {{ vm_uuid | default('N/A') }}
          âš¡ Estado: {{ vm_power_state | default('N/A') }}
          ğŸ’» SO: {{ vm_guest_os | default('N/A') }}
          ğŸ¢ Datacenter: {{ vm_datacenter | default('N/A') }}
          ğŸ—ï¸  Cluster: {{ vm_cluster | default('N/A') }}
          ğŸ“ Pasta: {{ vm_folder | default('N/A') }}
          ğŸ”§ CPU: {{ vm_cpu_count | default('N/A') }} cores
          ğŸ’¾ MemÃ³ria: {{ vm_memory_gb | default('N/A') }} GB
          ğŸŒ IP: {{ vm_ip_addresses | default('N/A') }}
          ğŸ–¥ï¸  Hostname: {{ vm_hostname | default('N/A') }}
          ğŸ› ï¸  VMware Tools: {{ vm_tools_status | default('N/A') }}
          ğŸ“‚ Datastores: {{ vm_datastores | default('N/A') }}
          ğŸ”— Redes: {{ vm_networks | default('N/A') }}
          ğŸ“ AnotaÃ§Ã£o: {{ vm_annotation | default('N/A') }}
          =====================================

- name: ğŸ“ˆ EstatÃ­sticas por Grupo - VMs Ligadas
  hosts: powered_on
  gather_facts: false
  run_once: true
  vars:
    ansible_connection: local

  tasks:
    - name: ğŸ“Š Contar VMs ligadas
      debug:
        msg: "âœ… Total de VMs ligadas: {{ groups['powered_on'] | length }}"

- name: ğŸ“‰ EstatÃ­sticas por Grupo - VMs Desligadas
  hosts: powered_off
  gather_facts: false
  run_once: true
  vars:
    ansible_connection: local

  tasks:
    - name: ğŸ“Š Contar VMs desligadas
      debug:
        msg: "âŒ Total de VMs desligadas: {{ groups['powered_off'] | length }}"

- name: ğŸªŸ RelatÃ³rio de VMs Windows
  hosts: windows
  gather_facts: false
  run_once: true
  vars:
    ansible_connection: local

  tasks:
    - name: ğŸ“Š EstatÃ­sticas Windows
      debug:
        msg: |
          ğŸªŸ RELATÃ“RIO WINDOWS
          Total de VMs Windows: {{ groups['windows'] | length }}
          VMs Windows ligadas: {{ groups['windows'] | intersect(groups['powered_on'] | default([])) | length }}
          VMs Windows desligadas: {{ groups['windows'] | intersect(groups['powered_off'] | default([])) | length }}

- name: ğŸ§ RelatÃ³rio de VMs Linux
  hosts: linux
  gather_facts: false
  run_once: true
  vars:
    ansible_connection: local

  tasks:
    - name: ğŸ“Š EstatÃ­sticas Linux
      debug:
        msg: |
          ğŸ§ RELATÃ“RIO LINUX
          Total de VMs Linux: {{ groups['linux'] | length }}
          VMs Linux ligadas: {{ groups['linux'] | intersect(groups['powered_on'] | default([])) | length }}
          VMs Linux desligadas: {{ groups['linux'] | intersect(groups['powered_off'] | default([])) | length }}

- name: âš¡ RelatÃ³rio de Alto Desempenho
  hosts: high_performance
  gather_facts: false
  run_once: true
  vars:
    ansible_connection: local

  tasks:
    - name: ğŸ“Š VMs de alto desempenho
      debug:
        msg: |
          âš¡ RELATÃ“RIO ALTO DESEMPENHO
          VMs com alto desempenho: {{ groups['high_performance'] | default([]) | length }}
          CritÃ©rio: >= 8 CPUs e >= 16GB RAM

- name: ğŸ› ï¸ RelatÃ³rio VMware Tools
  hosts: all
  gather_facts: false
  run_once: true
  vars:
    ansible_connection: local

  tasks:
    - name: ğŸ“Š Status VMware Tools
      debug:
        msg: |
          ğŸ› ï¸  RELATÃ“RIO VMWARE TOOLS
          Tools OK: {{ groups['tools_ok'] | default([]) | length }}
          Tools Desatualizadas: {{ groups['tools_outdated'] | default([]) | length }}
          Tools NÃ£o Instaladas: {{ groups['tools_not_installed'] | default([]) | length }}

- name: ğŸ“¸ RelatÃ³rio de Snapshots
  hosts: has_snapshots
  gather_facts: false
  run_once: true
  vars:
    ansible_connection: local

  tasks:
    - name: ğŸ“Š VMs com snapshots
      debug:
        msg: |
          ğŸ“¸ RELATÃ“RIO SNAPSHOTS
          VMs com snapshots: {{ groups['has_snapshots'] | default([]) | length }}
          VMs com mÃºltiplos snapshots: {{ groups['multiple_snapshots'] | default([]) | length }}
      when: groups['has_snapshots'] is defined

- name: ğŸ¯ RelatÃ³rio de VMs que Precisam de AtenÃ§Ã£o
  hosts: needs_attention
  gather_facts: false
  vars:
    ansible_connection: local

  tasks:
    - name: âš ï¸ Listar VMs problemÃ¡ticas
      debug:
        msg: |
          âš ï¸  VM PRECISA DE ATENÃ‡ÃƒO
          Nome: {{ vm_name }}
          Motivo: {% if vm_tools_status != 'toolsOk' %}VMware Tools: {{ vm_tools_status }}{% endif %}{% if vm_power_state == 'poweredOff' %} | VM Desligada{% endif %}
      when: vm_tools_status != 'toolsOk' or vm_power_state == 'poweredOff'

- name: ğŸ“‹ RelatÃ³rio Final - Resumo Executivo
  hosts: localhost
  gather_facts: false
  run_once: true
  vars:
    ansible_connection: local

  tasks:
    - name: ğŸ“Š Resumo executivo
      debug:
        msg: |

          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘        RESUMO EXECUTIVO VMWARE         â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘ ğŸ“Š Total de VMs: {{ groups['all'] | length }}
          â•‘ âœ… VMs Ligadas: {{ groups['powered_on'] | default([]) | length }}
          â•‘ âŒ VMs Desligadas: {{ groups['powered_off'] | default([]) | length }}
          â•‘ â¸ï¸  VMs Suspensas: {{ groups['suspended'] | default([]) | length }}
          â•‘ ğŸªŸ VMs Windows: {{ groups['windows'] | default([]) | length }}
          â•‘ ğŸ§ VMs Linux: {{ groups['linux'] | default([]) | length }}
          â•‘ ğŸš€ CPU Alto: {{ groups['high_cpu'] | default([]) | length }}
          â•‘ ğŸ’¾ MemÃ³ria Alta: {{ groups['high_memory'] | default([]) | length }}
          â•‘ âš¡ Alto Desempenho: {{ groups['high_performance'] | default([]) | length }}
          â•‘ ğŸ› ï¸  Tools OK: {{ groups['tools_ok'] | default([]) | length }}
          â•‘ âš ï¸  Precisam AtenÃ§Ã£o: {{ groups['needs_attention'] | default([]) | length }}
          â•‘ ğŸ“¸ Com Snapshots: {{ groups['has_snapshots'] | default([]) | length }}
          â•‘ ğŸ­ ProduÃ§Ã£o: {{ groups['production'] | default([]) | length }}
          â•‘ ğŸ§ª Desenvolvimento: {{ groups['development'] | default([]) | length }}
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          ğŸ“… RelatÃ³rio gerado em: {{ ansible_date_time.iso8601 | default('N/A') }}
          ğŸ¢ Datacenter: {{ datacenter_name }}
          ğŸ”— vCenter: {{ vcenter_hostname }}

- name: ğŸ’¾ Salvar relatÃ³rio em arquivo (opcional)
  hosts: localhost
  gather_facts: true
  run_once: true
  vars:
    ansible_connection: local
    report_file: "/tmp/vmware_inventory_report_{{ ansible_date_time.date }}.json"

  tasks:
    - name: ğŸ“„ Criar relatÃ³rio JSON
      copy:
        content: |
          {
            "report_timestamp": "{{ ansible_date_time.iso8601 }}",
            "datacenter": "{{ datacenter_name }}",
            "vcenter": "{{ vcenter_hostname }}",
            "summary": {
              "total_vms": {{ groups['all'] | length }},
              "powered_on": {{ groups['powered_on'] | default([]) | length }},
              "powered_off": {{ groups['powered_off'] | default([]) | length }},
              "suspended": {{ groups['suspended'] | default([]) | length }},
              "windows": {{ groups['windows'] | default([]) | length }},
              "linux": {{ groups['linux'] | default([]) | length }},
              "high_cpu": {{ groups['high_cpu'] | default([]) | length }},
              "high_memory": {{ groups['high_memory'] | default([]) | length }},
              "tools_ok": {{ groups['tools_ok'] | default([]) | length }},
              "needs_attention": {{ groups['needs_attention'] | default([]) | length }},
              "has_snapshots": {{ groups['has_snapshots'] | default([]) | length }}
            },
            "groups": {{ groups | to_nice_json }}
          }
        dest: "{{ report_file }}"
        mode: "0644"
      delegate_to: localhost
      run_once: true

    - name: âœ… RelatÃ³rio salvo
      debug:
        msg: "ğŸ“„ RelatÃ³rio detalhado salvo em: {{ report_file }}"
