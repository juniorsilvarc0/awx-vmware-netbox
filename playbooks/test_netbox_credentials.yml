---
- name: 🔍 Teste de Credenciais NetBox
  hosts: localhost
  gather_facts: false
  become: false
  vars:
    ansible_connection: local
    netbox_url: "http://177.93.133.239:8000"
    netbox_token: "2e6be1f776b91aa3849dc3723632983e4a80443a"

  tasks:
    - name: 📊 Mostrar configuração
      debug:
        msg:
          - "🔗 NetBox URL: {{ netbox_url }}"
          - "🔑 Token: {{ netbox_token[:8] }}...{{ netbox_token[-4:] }}"

    - name: 🌐 Testar conectividade NetBox
      uri:
        url: "{{ netbox_url }}/api/status/"
        method: GET
        headers:
          Authorization: "Token {{ netbox_token }}"
        validate_certs: false
        timeout: 10
      register: netbox_status
      failed_when: false

    - name: 📋 Mostrar resultado do teste
      debug:
        msg:
          - "📊 Status Code: {{ netbox_status.status | default('ERRO') }}"
          - "📝 Mensagem: {{ netbox_status.msg | default('N/A') }}"
          - "✅ Conectividade: {{ 'OK' if (netbox_status.status | default(0)) == 200 else 'FALHOU' }}"
          - "📄 Response: {{ netbox_status.json | default('N/A') }}"

    - name: ❌ Falhar se NetBox inacessível
      fail:
        msg: "🚫 NetBox inacessível: {{ netbox_status.msg | default('Erro desconhecido') }}"
      when: (netbox_status.status | default(0)) != 200

    - name: 🎉 Teste concluído com sucesso
      debug:
        msg: "✅ NetBox acessível e funcionando!"