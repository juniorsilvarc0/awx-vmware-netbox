---
- name: ğŸš€ Sincronizar VMs do AWX para o NetBox (Corrigido)
  hosts: all
  gather_facts: false
  vars:
    ansible_connection: local
    netbox_url: "{{ lookup('env', 'NETBOX_API') | default('') }}"
    netbox_token: "{{ lookup('env', 'NETBOX_TOKEN') | default('') }}"

  tasks:
    # ğŸ” ValidaÃ§Ã£o inicial
    - name: ğŸ” Validar configuraÃ§Ã£o
      fail:
        msg: |
          âŒ ConfiguraÃ§Ã£o invÃ¡lida:
          NetBox URL: {{ 'OK' if netbox_url != '' else 'FALTANDO' }}
          NetBox Token: {{ 'OK' if netbox_token != '' else 'FALTANDO' }}
          VM Name: {{ 'OK' if vm_name is defined else 'FALTANDO' }}

          Configure as variÃ¡veis NETBOX_API e NETBOX_TOKEN
      when: >
        netbox_url == '' or 
        netbox_token == '' or 
        vm_name is not defined or
        vm_name == ''
      run_once: true

    # ğŸ” Verificar se Ã© uma VM vÃ¡lida
    - name: ğŸ” Verificar se Ã© uma VM vÃ¡lida
      set_fact:
        is_valid_vm: >-
          {{
            vm_name is defined and 
            vm_name != 'localhost' and 
            vm_name != inventory_hostname and 
            vm_name != 'N/A' and 
            vm_name != ''
          }}

    # â­ï¸ Pular VMs invÃ¡lidas
    - name: â­ï¸ Pular VM invÃ¡lida
      meta: end_host
      when: not is_valid_vm

    # ğŸ“Š Debug da VM atual
    - name: ğŸ“Š Processar VM {{ vm_name }}
      debug:
        msg:
          - "ğŸ–¥ï¸  VM: {{ vm_name }}"
          - "âš¡ Estado: {{ vm_power_state | default('N/A') }}"
          - "ğŸ¢ Cluster: {{ vm_cluster | default('N/A') }}"
          - "ğŸ—ï¸  Datacenter: {{ vm_datacenter | default('N/A') }}"

    # ğŸ§ª Teste conectividade NetBox
    - name: ğŸ§ª Testar conectividade NetBox
      uri:
        url: "{{ netbox_url }}/api/status/"
        method: GET
        headers:
          Authorization: "Token {{ netbox_token }}"
        validate_certs: false
        timeout: 10
      register: netbox_status
      run_once: true
      delegate_to: localhost

    # ğŸ—ï¸ Criar site se necessÃ¡rio
    - name: ğŸ—ï¸ Verificar/Criar site no NetBox
      uri:
        url: "{{ netbox_url }}/api/dcim/sites/"
        method: POST
        headers:
          Authorization: "Token {{ netbox_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          name: "{{ vm_datacenter | default('Default-Site') }}"
          slug: "{{ (vm_datacenter | default('default-site')) | lower | replace('_', '-') }}"
          status: "active"
        status_code: [200, 201, 400] # 400 = jÃ¡ existe
      register: site_result
      run_once: true
      delegate_to: localhost
      when: vm_datacenter is defined

    # ğŸ” Obter ID do site
    - name: ğŸ” Obter ID do site
      uri:
        url: "{{ netbox_url }}/api/dcim/sites/?name={{ vm_datacenter | default('Default-Site') }}"
        method: GET
        headers:
          Authorization: "Token {{ netbox_token }}"
        return_content: true
      register: site_response
      delegate_to: localhost
      when: vm_datacenter is defined

    # ğŸ“ Definir site_id
    - name: ğŸ“ Definir site_id
      set_fact:
        site_id: "{{ (site_response.json.results | first).id if site_response.json.results else none }}"
      when:
        - vm_datacenter is defined
        - site_response is defined
        - site_response.json.results | length > 0

    # ğŸ¢ Criar cluster type se necessÃ¡rio
    - name: ğŸ¢ Criar cluster type VMware
      uri:
        url: "{{ netbox_url }}/api/virtualization/cluster-types/"
        method: POST
        headers:
          Authorization: "Token {{ netbox_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          name: "VMware vSphere"
          slug: "vmware-vsphere"
        status_code: [200, 201, 400]
      register: cluster_type_result
      run_once: true
      delegate_to: localhost

    # ğŸ” Obter cluster type ID
    - name: ğŸ” Obter cluster type ID
      uri:
        url: "{{ netbox_url }}/api/virtualization/cluster-types/?slug=vmware-vsphere"
        method: GET
        headers:
          Authorization: "Token {{ netbox_token }}"
        return_content: true
      register: cluster_type_response
      run_once: true
      delegate_to: localhost

    # ğŸ¢ Criar cluster se necessÃ¡rio
    - name: ğŸ¢ Verificar/Criar cluster no NetBox
      uri:
        url: "{{ netbox_url }}/api/virtualization/clusters/"
        method: POST
        headers:
          Authorization: "Token {{ netbox_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          name: "{{ vm_cluster | default('Default-Cluster') }}"
          type: "{{ (cluster_type_response.json.results | first).id }}"
          site: "{{ site_id | default(omit) }}"
        status_code: [200, 201, 400]
      register: cluster_result
      delegate_to: localhost
      when:
        - vm_cluster is defined
        - cluster_type_response.json.results | length > 0

    # ğŸ” Obter ID do cluster
    - name: ğŸ” Obter ID do cluster
      uri:
        url: "{{ netbox_url }}/api/virtualization/clusters/?name={{ vm_cluster | default('Default-Cluster') }}"
        method: GET
        headers:
          Authorization: "Token {{ netbox_token }}"
        return_content: true
      register: cluster_response
      delegate_to: localhost
      when: vm_cluster is defined

    # ğŸ“ Definir cluster_id
    - name: ğŸ“ Definir cluster_id
      set_fact:
        cluster_id: "{{ (cluster_response.json.results | first).id if cluster_response.json.results else none }}"
      when:
        - vm_cluster is defined
        - cluster_response is defined
        - cluster_response.json.results | length > 0

    # ğŸ” Verificar se a VM jÃ¡ existe
    - name: ğŸ” Verificar se VM {{ vm_name }} jÃ¡ existe
      uri:
        url: "{{ netbox_url }}/api/virtualization/virtual-machines/?name={{ vm_name }}"
        method: GET
        headers:
          Authorization: "Token {{ netbox_token }}"
        return_content: true
      register: vm_check_response
      delegate_to: localhost

    # ğŸ“ Definir vm_id se existir
    - name: ğŸ“ Definir vm_id se existir
      set_fact:
        vm_id: "{{ (vm_check_response.json.results | first).id if vm_check_response.json.results else none }}"

    # ğŸ–¥ï¸ Montar payload da VM
    - name: ğŸ–¥ï¸ Montar payload da VM
      set_fact:
        vm_payload:
          name: "{{ vm_name }}"
          status: "{{ 'active' if vm_power_state == 'poweredOn' else 'offline' }}"
          cluster: "{{ cluster_id | default(omit) }}"
          vcpus: "{{ vm_cpu_count | default(1) | int }}"
          memory: "{{ vm_memory_mb | default(1024) | int }}"
          comments: |
            Sincronizado via AWX
            Host: {{ inventory_hostname }}
            Data: {{ ansible_date_time.iso8601 }}
            UUID: {{ vm_uuid | default('N/A') }}
            Environment: {{ vm_environment | default('unknown') }}
            Criticality: {{ vm_criticality | default('low') }}

    # ğŸ’¾ Criar ou atualizar VM no NetBox
    - name: "ğŸ’¾ {{ 'Atualizar' if vm_id else 'Criar' }} VM {{ vm_name }} no NetBox"
      uri:
        url: >-
          {{ netbox_url }}/api/virtualization/virtual-machines/
          {{- vm_id ~ '/' if vm_id else '' }}
        method: "{{ 'PATCH' if vm_id else 'POST' }}"
        headers:
          Authorization: "Token {{ netbox_token }}"
          Content-Type: "application/json"
        body: "{{ vm_payload | to_json }}"
        status_code: [200, 201]
        body_format: json
        validate_certs: false
      register: vm_result
      delegate_to: localhost

    # âœ… Resultado
    - name: "âœ… Resultado para VM {{ vm_name }}"
      debug:
        msg:
          - "ğŸ–¥ï¸  VM: {{ vm_name }}"
          - "ğŸ“Š Status: {{ vm_result.status }}"
          - "{{ 'âœ… CRIADA' if vm_result.status == 201 else 'âœ… ATUALIZADA' if vm_result.status == 200 else 'âŒ ERRO' }}"
          - "ğŸ’¾ NetBox ID: {{ vm_result.json.id }}"
