---
# Playbook para coleta detalhada de facts das VMs - SOMENTE LEITURA
# Arquivo: playbooks/vm_facts_collection.yml

- name: ğŸ” Coleta Detalhada de Facts VMware
  hosts: all
  gather_facts: false
  vars:
    ansible_connection: local

  tasks:
    - name: ğŸ“‹ Aplicar role de coleta de facts
      include_role:
        name: vmware_facts
      when: vm_name is defined

- name: ğŸ“Š AnÃ¡lise de Performance das VMs
  hosts: powered_on
  gather_facts: false
  vars:
    ansible_connection: local

  tasks:
    - name: âš¡ Calcular mÃ©tricas de performance
      set_fact:
        vm_performance_score: >-
          {%- set cpu_score = (vm_cpu_count | default(1) | int) * 25 -%}
          {%- set memory_score = (vm_memory_gb | default(1) | float) * 10 -%}
          {%- set tools_score = 50 if vm_tools_status == 'toolsOk' else 0 -%}
          {{ (cpu_score + memory_score + tools_score) | int }}

        vm_performance_category: >-
          {%- set score = vm_performance_score | default(0) | int -%}
          {%- if score >= 300 -%}enterprise
          {%- elif score >= 200 -%}high
          {%- elif score >= 100 -%}medium
          {%- else -%}basic{%- endif -%}

    - name: ğŸ“ˆ Exibir anÃ¡lise de performance
      debug:
        msg: |
          ğŸ“ˆ ANÃLISE DE PERFORMANCE - {{ vm_name }}
          ==========================================
          ğŸ¯ Score Total: {{ vm_performance_score }}/500
          ğŸ† Categoria: {{ vm_performance_category | upper }}

          ğŸ“Š Componentes do Score:
          â”œâ”€ CPU ({{ vm_cpu_count }} cores): {{ (vm_cpu_count | default(1) | int) * 25 }} pts
          â”œâ”€ MemÃ³ria ({{ vm_memory_gb }}GB): {{ (vm_memory_gb | default(1) | float) * 10 }} pts
          â””â”€ VMware Tools: {{ 50 if vm_tools_status == 'toolsOk' else 0 }} pts

          ğŸ’¡ RecomendaÃ§Ãµes:
          {% if vm_performance_score < 100 %}â”œâ”€ âš ï¸  Performance bÃ¡sica - considerar upgrade{% endif %}
          {% if vm_tools_status != 'toolsOk' %}â”œâ”€ ğŸ› ï¸  Atualizar VMware Tools{% endif %}
          {% if vm_cpu_count < 2 %}â”œâ”€ ğŸ”§ Considerar adicionar mais CPUs{% endif %}
          {% if vm_memory_gb < 4 %}â”œâ”€ ğŸ’¾ Considerar adicionar mais memÃ³ria{% endif %}
      when: vm_performance_score is defined

- name: ğŸ·ï¸ ClassificaÃ§Ã£o AutomÃ¡tica de VMs
  hosts: all
  gather_facts: false
  vars:
    ansible_connection: local

  tasks:
    - name: ğŸ·ï¸ Gerar tags automÃ¡ticas
      set_fact:
        vm_auto_tags:
          - "vm_{{ vm_name | lower | regex_replace('[^a-z0-9]', '_') }}"
          - "state_{{ vm_power_state | lower }}"
          - "cpu_{{ vm_cpu_category | default('unknown') }}"
          - "memory_{{ vm_memory_category | default('unknown') }}"
          - "tools_{{ vm_tools_status | lower | regex_replace('tools', '') | default('unknown') }}"
          - "os_{{ vm_guest_family | lower | default('unknown') }}"
          - "env_{{ vm_environment | lower }}"
          - "criticality_{{ vm_criticality | lower }}"
          - "datacenter_{{ vm_datacenter | lower | regex_replace('[^a-z0-9]', '_') | default('unknown') }}"
          - "cluster_{{ vm_cluster | lower | regex_replace('[^a-z0-9]', '_') | default('unknown') }}"

    - name: ğŸ“ Exibir classificaÃ§Ã£o da VM
      debug:
        msg: |
          ğŸ·ï¸  CLASSIFICAÃ‡ÃƒO AUTOMÃTICA - {{ vm_name }}
          =============================================
          ğŸ“Š Ambiente: {{ vm_environment | title }}
          ğŸ“ˆ Criticidade: {{ vm_criticality | title }}
          ğŸ—ï¸  LocalizaÃ§Ã£o: {{ vm_datacenter }}/{{ vm_cluster }}

          ğŸ·ï¸  Tags Geradas:
          {% for tag in vm_auto_tags %}
          â”œâ”€ {{ tag }}
          {% endfor %}
      when: vm_auto_tags is defined

- name: ğŸ” AnÃ¡lise de Conformidade
  hosts: all
  gather_facts: false
  vars:
    ansible_connection: local

  tasks:
    - name: âœ… Verificar conformidade bÃ¡sica
      set_fact:
        vm_compliance_checks:
          vmware_tools_ok: "{{ vm_tools_status == 'toolsOk' }}"
          has_minimum_resources: "{{ vm_cpu_count >= 1 and vm_memory_gb >= 1 }}"
          is_properly_named: "{{ vm_name | length > 3 and vm_name != vm_uuid }}"
          has_ip_address: "{{ vm_ip_addresses is defined and vm_ip_addresses | length > 0 }}"
          in_known_datacenter: "{{ vm_datacenter is defined and vm_datacenter != '' }}"

        vm_compliance_score: >-
          {%- set checks = [
            vm_tools_status == 'toolsOk',
            vm_cpu_count >= 1 and vm_memory_gb >= 1,
            vm_name | length > 3 and vm_name != vm_uuid,
            vm_ip_addresses is defined and vm_ip_addresses | length > 0,
            vm_datacenter is defined and vm_datacenter != ''
          ] -%}
          {{ (checks | select | list | length / checks | length * 100) | round(0) | int }}

    - name: ğŸ“‹ RelatÃ³rio de conformidade
      debug:
        msg: |
          ğŸ“‹ ANÃLISE DE CONFORMIDADE - {{ vm_name }}
          ==========================================
          ğŸ¯ Score de Conformidade: {{ vm_compliance_score }}%

          âœ… VerificaÃ§Ãµes:
          â”œâ”€ VMware Tools OK: {{ 'âœ…' if vm_compliance_checks.vmware_tools_ok else 'âŒ' }}
          â”œâ”€ Recursos MÃ­nimos: {{ 'âœ…' if vm_compliance_checks.has_minimum_resources else 'âŒ' }}
          â”œâ”€ Nome Adequado: {{ 'âœ…' if vm_compliance_checks.is_properly_named else 'âŒ' }}
          â”œâ”€ Tem EndereÃ§o IP: {{ 'âœ…' if vm_compliance_checks.has_ip_address else 'âŒ' }}
          â””â”€ Datacenter Conhecido: {{ 'âœ…' if vm_compliance_checks.in_known_datacenter else 'âŒ' }}

          {% if vm_compliance_score < 100 %}
          âš ï¸  AÃ§Ãµes Recomendadas:
          {% if not vm_compliance_checks.vmware_tools_ok %}â”œâ”€ Instalar/atualizar VMware Tools{% endif %}
          {% if not vm_compliance_checks.has_minimum_resources %}â”œâ”€ Verificar configuraÃ§Ã£o de recursos{% endif %}
          {% if not vm_compliance_checks.is_properly_named %}â”œâ”€ Revisar convenÃ§Ã£o de nomenclatura{% endif %}
          {% if not vm_compliance_checks.has_ip_address %}â”œâ”€ Verificar configuraÃ§Ã£o de rede{% endif %}
          {% endif %}
      when: vm_compliance_checks is defined

- name: ğŸ“Š RelatÃ³rio Consolidado de Facts
  hosts: localhost
  gather_facts: true
  run_once: true
  vars:
    ansible_connection: local

  tasks:
    - name: ğŸ“ˆ Calcular estatÃ­sticas de performance
      set_fact:
        performance_stats:
          enterprise_vms: "{{ ansible_play_hosts | map('extract', hostvars, 'vm_performance_category') | select('equalto', 'enterprise') | list | length }}"
          high_performance_vms: "{{ ansible_play_hosts | map('extract', hostvars, 'vm_performance_category') | select('equalto', 'high') | list | length }}"
          medium_performance_vms: "{{ ansible_play_hosts | map('extract', hostvars, 'vm_performance_category') | select('equalto', 'medium') | list | length }}"
          basic_performance_vms: "{{ ansible_play_hosts | map('extract', hostvars, 'vm_performance_category') | select('equalto', 'basic') | list | length }}"

    - name: ğŸ“Š Exibir relatÃ³rio consolidado
      debug:
        msg: |

          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘         RELATÃ“RIO CONSOLIDADO DE FACTS         â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘ ğŸ“ˆ ANÃLISE DE PERFORMANCE                      â•‘
          â•‘   â€¢ Enterprise: {{ performance_stats.enterprise_vms }} VMs                     â•‘
          â•‘   â€¢ Alto Desempenho: {{ performance_stats.high_performance_vms }} VMs            â•‘
          â•‘   â€¢ MÃ©dio Desempenho: {{ performance_stats.medium_performance_vms }} VMs           â•‘
          â•‘   â€¢ BÃ¡sico: {{ performance_stats.basic_performance_vms }} VMs                      â•‘
          â•‘                                                â•‘
          â•‘ ğŸ·ï¸  CLASSIFICAÃ‡ÃƒO                              â•‘
          â•‘   â€¢ Total de VMs Classificadas: {{ ansible_play_hosts | length }}              â•‘
          â•‘   â€¢ Tags AutomÃ¡ticas: Geradas                 â•‘
          â•‘   â€¢ Conformidade: Analisada                   â•‘
          â•‘                                                â•‘
          â•‘ ğŸ“… INFORMAÃ‡Ã•ES DA COLETA                      â•‘
          â•‘   â€¢ Data/Hora: {{ ansible_date_time.iso8601 }}      â•‘
          â•‘   â€¢ Modo: Coleta de Facts (Somente Leitura)   â•‘
          â•‘   â€¢ Fonte: VMware vCenter                     â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
